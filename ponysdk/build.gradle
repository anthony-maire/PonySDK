ext {
    srcTerminal = ""
    resourcesCoreTest = "src/test/resources"
    gwtOutputDirName = buildDir.name + "/gwt"
    buildInfoOutputDirName = buildDir.name + "/buildinfo"
    javadocResources = "src/main/javadoc"
    jettyVersion = '9.3.12.v20160915'
}

repositories {
    mavenCentral()
    maven {
        url "https://github.com/PonySDK/Maven/raw/master/ext"
    }
    maven {
        url "http://oss.sonatype.org/content/repositories/snapshots"
    }
}

uploadArchives {
    repositories {
        mavenDeployer {
            repository(url: "file://localhost/tmp/my-maven-repo/")
            pom.groupId = 'com.ponysdk'
            pom.artifactId = 'ponysdk'
        }
    }
}

configurations {
    all {
        transitive = false
    }

    xjc
    gwtdev
}

dependencies {
    xjc 'com.sun.xml.bind:jaxb-xjc:2.2.4'

    gwtdev 'com.google.gwt:gwt-dev:2.8.0-rc3'

    compile('javax.validation:validation-api:1.1.0.Final') {
        artifact {
            name = 'validation-api'
            type = 'jar'
        }
        artifact {
            name = 'validation-api'
            type = 'jar'
            classifier = 'sources'
        }
    }
    
	compile('com.google.jsinterop:jsinterop-annotations:1.0.0'){
        artifact {
            name = 'jsinterop-annotations'
            type = 'jar'
        }
        artifact {
            name = 'jsinterop-annotations'
            type = 'jar'
            classifier = 'sources'
        }
    }
    
    compile 'com.google.gwt:gwt-user:2.8.0-rc3'
    compile 'org.timepedia.exporter:gwtexporter:2.5.1'
    compile 'com.google.gwt:gwt-elemental:2.8.0-rc3'
    compile 'org.ow2.asm:asm:5.0.4'
    compile 'org.apache.ant:ant:1.9.7'
    compile 'colt:colt:1.2.0'
	compile group: 'tapestry', name: 'tapestry', version: '4.0.2'
	compile group: 'org.apache.xmlgraphics', name: 'batik-css', version: '1.8'
	compile group: 'org.apache.xmlgraphics', name: 'batik-ext', version: '1.8'

    
    compile 'org.springframework:spring-core:4.3.3.RELEASE'
    compile 'org.springframework:spring-web:4.3.3.RELEASE'
    compile 'org.springframework:spring-beans:4.3.3.RELEASE'
    compile 'org.springframework:spring-context:4.3.3.RELEASE'

    compile 'org.slf4j:slf4j-api:1.7.21'
    compile 'org.slf4j:log4j-over-slf4j:1.7.21'
    compile 'ch.qos.logback:logback-core:1.1.3'
    compile 'ch.qos.logback:logback-classic:1.1.3'
    compile 'org.slf4j:jcl-over-slf4j:1.7.21'

    compile 'commons-beanutils:commons-beanutils:1.8.3'
    compile 'commons-lang:commons-lang:2.6'

    compile 'org.eclipse.jetty:jetty-server:' + jettyVersion
    compile 'org.eclipse.jetty:jetty-servlet:' + jettyVersion
    compile 'org.eclipse.jetty:jetty-webapp:' + jettyVersion
    compile 'org.eclipse.jetty:jetty-servlets:' + jettyVersion
    compile 'org.eclipse.jetty.websocket:websocket-api:' + jettyVersion
    compile 'org.eclipse.jetty.websocket:websocket-common:' + jettyVersion
    compile 'org.eclipse.jetty.websocket:websocket-server:' + jettyVersion
    compile 'org.eclipse.jetty.websocket:websocket-servlet:' + jettyVersion
    compile 'org.eclipse.jetty.websocket:javax-websocket-server-impl:' + jettyVersion
    compile 'org.eclipse.jetty:jetty-client:' + jettyVersion
    compile 'org.eclipse.jetty:jetty-io:' + jettyVersion
    compile 'org.eclipse.jetty:jetty-util:' + jettyVersion
    compile 'org.eclipse.jetty:jetty-http:' + jettyVersion
    compile 'org.eclipse.jetty:jetty-security:' + jettyVersion
    compile 'org.eclipse.jetty:jetty-continuation:' + jettyVersion

    compile 'org.apache.geronimo.specs:geronimo-servlet_3.0_spec:1.0'
    compile 'javax.servlet:javax.servlet-api:3.1.0'

    compile 'javax.json:javax.json-api:1.0'
    compile 'org.glassfish:javax.json:1.0.4'

    compile 'org.apache.lucene:lucene-core:6.1.0'
    compile 'org.apache.lucene:lucene-analyzers-common:6.1.0'
    compile 'org.apache.lucene:lucene-queryparser:6.1.0'


    testCompile 'org.seleniumhq.selenium:selenium-java:2.33.0'
    testCompile 'junit:junit:4.10'

    runtime 'org.ow2.asm:asm:5.0.3'
    runtime 'com.google.gwt:gwt-codeserver:2.8.0-rc3'
}

jar {
    baseName = 'ponysdk'
    from sourceSets.main.output
    from sourceSets.test.output
    from gwtOutputDirName

    metaInf {
        from 'src/main/resources/META-INF'
        from buildInfoOutputDirName
    }
    manifest {
        def cmd = "git rev-parse HEAD"
        def proc = cmd.execute()
        ext.revision = proc.text.trim()
        ext.timestamp = (int) (new Date().getTime() / 1000)

        attributes("Manifest-Version": "1.0")
        attributes("Created-By": "PonySDK")
        attributes("Built-By": "PonySDK")
        attributes("License-Title": "Apache License 2.0")
        attributes("Specification-Title": "PonySDK")
        attributes("Specification-Version": version)
        attributes("Specification-Vendor": "PonySDK")
        attributes("Implementation-Title": "PonySDK")
        attributes("Implementation-Version": version)
        attributes("Implementation-Vendor-Id": "com.ponysdk")
        attributes("Implementation-Vendor": "PonySDK")
        attributes("Revision": revision)
        attributes("Date": timestamp + " / " + new Date().toGMTString())
    }
}

task gwtc(dependsOn: classes, type: JavaExec) {
    inputs.files fileTree('src/main/java/com/ponysdk/core/terminal')
    outputs.files fileTree(gwtOutputDirName)
    description = "GWT compile to JavaScript (production mode)"
    main = 'com.google.gwt.dev.Compiler'
    workingDir = buildDir

    classpath {
        [
                sourceSets.main.java.srcDirs,
                configurations.compile,
                configurations.gwtdev
        ]
    }

    args = [
            '-war',
            'gwt',
            '-localWorkers',
            Runtime.getRuntime().availableProcessors(),
            'com.ponysdk.core.PonyTerminal',
            //'-style', 'DETAILED',
            //'-optimize', '0'
    ]

    maxHeapSize = '512M'
}

// custom tasks for creating source/javadoc jars
task sourcesJar(type: Jar, dependsOn: classes) {
    classifier = 'sources'
    from sourceSets.main.allJava
    from sourceSets.test.allJava

    from(sourceSets.main.java.srcDirs) {
        include '**/*.xml'
    }

    manifest {
        def cmd = "git rev-parse HEAD"
        def proc = cmd.execute()
        ext.revision = proc.text.trim()
        ext.timestamp = (int) (new Date().getTime() / 1000)

        attributes("Manifest-Version": "1.0")
        attributes("Created-By": "PonySDK")
        attributes("Built-By": "PonySDK")
        attributes("License-Title": "Apache License 2.0")
        attributes("Specification-Title": "PonySDK")
        attributes("Specification-Version": version)
        attributes("Specification-Vendor": "PonySDK")
        attributes("Implementation-Title": "PonySDK")
        attributes("Implementation-Version": version)
        attributes("Implementation-Vendor-Id": "com.ponysdk")
        attributes("Implementation-Vendor": "PonySDK")
        attributes("Revision": revision)
        attributes("Classifier": "sources")
        attributes("Date": timestamp + " / " + new Date().toGMTString())
    }
}
task myJavadoc(type: Javadoc) {
    source = sourceSets.main.allJava
    exclude '**/com/ponysdk/core/terminal/**'
}


task javadocJar(type: Jar, dependsOn: myJavadoc) {
    classifier = 'javadoc'
    from javadoc.destinationDir
    /**
     title = 'PonySDK javadoc'
     excludes = ['com.ponysdk.ui.terminal']
     doLast {copy {from javadocResources
     into buildDir.name + '/docs/javadoc';}}**/

    manifest {
        def cmd = "git rev-parse HEAD"
        def proc = cmd.execute()
        ext.revision = proc.text.trim()
        ext.timestamp = (int) (new Date().getTime() / 1000)

        attributes("Manifest-Version": "1.0")
        attributes("Created-By": "PonySDK")
        attributes("Built-By": "PonySDK")
        attributes("License-Title": "Apache License 2.0")
        attributes("Specification-Title": "PonySDK")
        attributes("Specification-Version": version)
        attributes("Specification-Vendor": "PonySDK")
        attributes("Implementation-Title": "PonySDK")
        attributes("Implementation-Version": version)
        attributes("Implementation-Vendor-Id": "com.ponysdk")
        attributes("Implementation-Vendor": "PonySDK")
        attributes("Revision": revision)
        attributes("Classifier": "javadocs")
        attributes("Date": timestamp + " / " + new Date().toGMTString())
    }
}

test {
    classpath = files(resourcesCoreTest, gwtOutputDirName) + classpath
    afterSuite { desc, result ->
        if (!desc.parent) {
            println "Results: ${result.resultType} (${result.testCount} tests, ${result.successfulTestCount} successes, ${result.failedTestCount} failures, ${result.skippedTestCount} skipped)"
        }
    }
}

// add javadoc/source jar tasks as artifacts
artifacts {
    archives sourcesJar
    archives javadocJar
}

jar.dependsOn('gwtc')
